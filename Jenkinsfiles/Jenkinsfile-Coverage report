pipeline {
    agent any
    parameters {
        string(name: 'LOCAL_APP_PATH', defaultValue: '/var/lib/jenkins/workspace/testJenkinsFlow/app', description: 'Local App Directory Path')
        string(name: 'LOCAL_TEST_PATH', defaultValue: '/var/lib/jenkins/workspace/testJenkinsFlow/test', description: 'Local Test Directory Path')
    }
    stages {
        stage('Clean Workspace') {
            steps {
                script {
                    deleteDir() // Clean workspace before starting
                }
            }
        }
        stage('Copy Local App Files') {
            steps {
                dir('app'){
                sh "cp -r ${params.LOCAL_APP_PATH}/* ."
                
                }
            }
        }
        stage('Copy Local Test Files') {
            steps {
                dir('test'){
                    sh "cp -r ${params.LOCAL_TEST_PATH}/* ."
                }
            }
        }
        stage('Generate Coverage Report') {
            steps {
                dir('test') {
                    script {
                        // Install coverage.py
                        sh 'sudo apt-get install python3-venv -y'
                        sh 'python3 -m venv myenv'
                        sh '. myenv/bin/activate'
                        sh 'pip install coverage'
                        // Run coverage tool to generate coverage report for app files only
                        sh 'coverage run --source ../app -m unittest discover -s . -p "*_test.py"'
                        sh 'coverage report'
                        sh 'coverage xml -o coverage.xml'
                    }
                }
            }
        }
    }
    post {
        always {
            // Display coverage report as build result
            script {
                dir('test'){
                    def coverageReport = sh(script: 'coverage report', returnStdout: true).trim()
                    echo "Coverage Report:\n${coverageReport}"
                }
            }
        }
    }
}
